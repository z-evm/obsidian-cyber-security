**Heap exploitation** is a subset of memory corruption techniques that targets the **heap memory** used for dynamic allocation. By corrupting heap metadata or abusing memory management logic, attackers can gain **arbitrary code execution**, **privilege escalation**, or **information disclosure**.

---

## üß† What Is the Heap?

- A **region of memory** used for dynamically allocated data (via `malloc()`, `calloc()`, `new`, etc.)
- Managed by **allocators** (e.g., `glibc malloc`, `ptmalloc`, `tcmalloc`)
- Unlike the stack, heap memory is **non-linear** and persists across function calls

> Exploiting the heap often involves **tricking the allocator** into writing or executing attacker-controlled data.

---

## üî• Common Heap Vulnerabilities

| Type                | Description                                                     | Exploit Vector                          |
|---------------------|------------------------------------------------------------------|------------------------------------------|
| **Heap Overflow**     | Writing beyond a heap buffer‚Äôs boundary                        | Metadata corruption, pointer hijack      |
| **Use-After-Free**    | Using memory after it's freed                                  | Allows access to stale data, re-use      |
| **Double Free**       | Freeing the same pointer twice                                 | Leads to allocator corruption            |
| **Uninitialized Read**| Reading memory before it's initialized                         | May leak sensitive data                  |
| **Heap Spraying**     | Filling the heap with attacker data to influence layout        | Used in browser and JIT exploitation     |

---

## üß∞ Exploitation Techniques

| Technique                 | Description                                                |
|---------------------------|------------------------------------------------------------|
| **Fastbin Duplication**    | Abuse of freelist pointers to allocate memory at arbitrary address |
| **Unlink Attacks**         | Corrupt forward/backward pointers to overwrite memory     |
| **Tcache Poisoning**       | Overwrite tcache bins (modern glibc) for address redirection |
| **House of Force**         | Force heap extension by corrupting top chunk size         |
| **House of Spirit**        | Trick malloc into returning attacker-supplied fake chunk  |
| **Use-After-Free Reuse**   | Reuse dangling pointers for code or data injection        |

---

## üì¶ Example: Fastbin Duplication (glibc)

1. Free the same chunk twice (double free)
2. Corrupt freelist to point to a fake chunk
3. Next `malloc()` returns a pointer to the controlled location
4. Overwrite GOT entry or function pointer

---

## üîß Tools and Environments

| Tool             | Purpose                                          |
|------------------|--------------------------------------------------|
| **GDB + pwndbg** | Live heap inspection and debugging               |
| **Heap Exploitation Cheat Sheet** | Online resource with primitives |
| **Heaplab / heaptrace** | Track allocator behavior in live programs |
| **glibc source** | Understand malloc internals (ptmalloc)           |
| **Libheap**      | Python GDB plugin for heap introspection         |
| **Custom C binaries** | Lab examples with malloc/free scenarios     |

---

## üß± Common Lab Targets

- **Protostar (heap series)**
- **Heaplab (by dhavalkapil)**
- **Heap Exploitation Practice (0x7f on GitHub)**
- **picoCTF / HackTheBox pwn challenges**
- **CTF archives (e.g., Pwnable.kr, CTFtime)**

---

## üîê Heap Mitigations

| Mitigation       | Description                                     |
|------------------|-------------------------------------------------|
| **ASLR**         | Randomizes heap base address                    |
| **Safe Unlinking**| Checks before unlink operations (modern glibc) |
| **Tcache**       | Introduced in glibc 2.26, changes freelist logic|
| **Hardening Flags**| Compiler-level protections (`-D_FORTIFY_SOURCE`) |
| **Pointer Encoding** | Protects freelist pointers from corruption  |

---

## üß† Knowledge Required

- C programming and `malloc/free`
- glibc internals (ptmalloc)
- GDB debugging and memory inspection
- Binary exploitation flow: fuzz ‚Üí leak ‚Üí hijack
- Understanding of heap chunk layout

---

## üìò Real-World CVEs

| CVE ID           | Description                                    | Technique            |
|------------------|------------------------------------------------|----------------------|
| **CVE-2019-5736**| Docker escape via runc Use-After-Free         | UAF, container escape|
| **CVE-2017-1000364**| Sudo heap overflow vulnerability            | Out-of-bounds write  |
| **CVE-2021-3156**| Sudo heap-based buffer overflow (Baron Samedit)| Off-by-one + heap     |

---

## üîó Related Topics

- [[Memory Corruption]]
- [[Buffer Overflow]]
- [[Exploit Development]]
- [[GDB + pwndbg]]
- [[Use-After-Free]]
- [[Dynamic Analysis]]

---

## üè∑ Suggested Tags

#heap_exploitation #memory_corruption #pwn #exploit_dev #glibc #heap_overflow #CVE

---

## ‚úÖ To Do

- [ ] Practice fastbin and tcache poisoning attacks
- [ ] Reverse engineer glibc malloc behavior in test binary
- [ ] Build a heap exploit lab using Ubuntu 18.04 (glibc 2.27)
- [ ] Create notes for House of Force and House of Spirit
